---
title: "Seattle Car Crashes"
author: "Simoli Aghara, Mindy Chen, Rachel Graham, Tammy Le"
date: "`r Sys.Date()`"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(readxl)
library(tidyverse)
library(DT)
library(dplyr)
library(ggmap)
library(ggplot2)
library(plotly)
library(shiny)
library(lubridate)
```


About
===================================== 

### About Section

##### Introduction:
Seattle's frequent car accidents, often attributed to its grey weather and rainy conditions, prompt the need for a comprehensive understanding of these incidents. This dashboard aims to shed light on car crashes in Seattle from January 1, 2018, to February 8, 2024, using a series of visualizations.

##### Data Table Overview:
The dashboard begins with a concise overview of the dataset in tabular form, providing users with a foundational understanding of the data used to generate subsequent visualizations.

##### Temporal Analysis Map:
A dynamic map illustrates the spatial distribution of car crashes in Seattle over time. Users can observe patterns, hotspots, and temporal trends to gain insights into accident occurrences across different neighborhoods and roadways.

##### Attribution of Accident Causes:
Delving deeper, the dashboard analyzes the primary causes of accidentsâ€”be it adverse weather conditions, road infrastructure, or inadequate lighting. The visualization has been divided into two parts to provide better understanding. These visualization elucidates the factors contributing most significantly to car crashes, aiding in pinpointing areas for potential safety enhancements.

##### Injury Severity Analysis:
Furthermore, the dashboard explores the types of accidents that result in the most severe injuries, identifying both the location and nature of incidents. This critical insight enables stakeholders to prioritize interventions aimed at reducing the incidence of severe injuries in specific contexts.

##### Location-Based Analysis:
A breakdown of accident-prone locations reveals where the majority of crashes occur, offering valuable insights into high-risk areas. Notably, the visualization highlights common scenarios such as left-turn accidents, providing actionable information for targeted intervention strategies.

##### Limitations:
Acknowledging the limitations, it's important to note the absence of data for weather, road, and light conditions in the year 2024. This constraint impacts the comprehensiveness of the analysis for the most recent period.

##### Objective and Impact:
In essence, the dashboard seeks to address the challenge of designing an accessible platform that synthesizes essential information about car collisions in Seattle. By facilitating a deeper understanding of accident attributes, the dashboard aims to empower auto engineers to implement safety adjustments and policymakers to enact targeted traffic safety measures. Ultimately, the overarching goal is to raise public awareness of the primary factors contributing to car crashes and foster a safer urban environment for all.

##### GitHub Link:

Table
===================================== 

```{r Reading and Displaying Data}
Seattle_Car_Crashes <- read_excel("Seattle Car Crashes.xlsx")
Seattle_Car_Crashes <- na.omit(Seattle_Car_Crashes)
Seattle_Car_Crashes <- subset(Seattle_Car_Crashes, select = -c(INCDTTM))
datatable(Seattle_Car_Crashes)

```

Geolocation
===================================== 

```{r GeoLocation}

```


Scatter
===================================== 

```{r Scatter Plot}
Seattle_Car_Crashes_Date <- Seattle_Car_Crashes %>%
  mutate(year = year(INCDATE), month = month(INCDATE))

total_accident <- Seattle_Car_Crashes_Date %>%
  group_by(year, month, WEATHER, ROADCOND) %>%
  summarise(Number_Accidents = n())

ui <- fluidPage(
  titlePanel("Seattle Car Crashes Weather and Road Conditions by Year"),
  
  fluidRow(
    column(
          width = 8,
          selectInput("year","Select Year",choices = unique(total_accident$year))
      )
  ),

  fluidRow(
    column(
          width = 12,
          plotlyOutput("plot", width = "90%", height = "600px")
    )
  )
)

server <- function(input, output) {
  Seattle_Car_Crashes_Date <- Seattle_Car_Crashes %>%
    mutate(year = year(INCDATE), month = month(INCDATE))
  # Data processing
  Seattle_Car_Crashes <- Seattle_Car_Crashes %>%
    mutate(Weather_Combined = case_when(
      WEATHER %in% c("Clear", "Overcast", "Partly Cloudy") ~ "Clear",
      WEATHER %in% c("Fog/Smog/Smoke") ~ "Fog",
      WEATHER %in% c("Raining", "Sleet/Hail/Freezing Rain") ~ "Rain",
      WEATHER %in% c("Snowing", "Blowing Snow") ~ "Snow",
      WEATHER %in% c("Other", "Blowing Sand/Dirt", "Severe Crosswind") ~ "Other",
      TRUE ~ WEATHER  # Keep other values unchanged
    )) %>%
    mutate(Road_Combined = case_when(
      ROADCOND == "Dry" ~ "Dry",
      ROADCOND %in% c("Wet", "Standing Water", "Snow/Slush", "Sand/Mud/Dirt", "Oil") ~ "Wet",
      ROADCOND == c("Ice") ~ "Ice",
      TRUE ~ ROADCOND  # Keep other values unchanged
    )) %>%
    filter(WEATHER != "Unknown" & ROADCOND != "Unknown" & ROADCOND != "Other")


  # Output the interactive plot
  output$plot <- renderPlotly({
    
    # Filter data based on user-selected year
    filtered_data <- Seattle_Car_Crashes %>%
      mutate(year = year(INCDATE), month = month(INCDATE)) %>% 
      filter(year == input$year) %>%
      group_by(month, WEATHER, ROADCOND, INCDATE, Road_Combined, Weather_Combined) %>%
      summarise(Number_Accidents = n())
    
    p <- ggplot(filtered_data, aes(x = month, y = Number_Accidents, color = Road_Combined, shape = Weather_Combined, text = paste("Weather:", Weather_Combined, "<br>Road:", Road_Combined, "<br>Crashes:", Number_Accidents))) +
      geom_point(size = 3) +
      scale_x_discrete(limits = 1:12, labels = month.abb) +
      labs(x = "Year-Month", y = "Number of Car Crashes", title = paste("Car Crashes by Weather and Road Condition in", input$year), color = "Road Condition", shape = "Weather Condition") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "top", panel.background = element_rect(fill = "lightgrey"))
    
    ggplotly(p) %>%
layout(legend = list(orientation = "h"))
    
    ggplotly(p, tooltip = "text")
  })
}

shinyApp(ui = ui, server = server)
```

Line
===================================== 

```{r Line Graph}
# Separating the date column from the dataset
Seattle_Car_Crashes_Date <- Seattle_Car_Crashes %>% select(INCDATE, LIGHTCOND) %>% drop_na() %>%
  mutate(year = year(INCDATE), month = month(INCDATE))

# Counting the total number of accidents happened in a particular month
total_accident <- Seattle_Car_Crashes_Date %>%
  group_by(LIGHTCOND, year, month) %>%
  summarise(Number_Accidents = n())

# Making the graph interactive
ui <- fluidPage(
  
  # Giving the title to the graph
  titlePanel("Car Crashes by Light Condition over Time"),
  
  # Adding Information about the visualization
  fluidRow(
    column(
      width = 12,
      h3("Visualization Description"),
      p("The following visualization presents a detailed analysis of how light conditions have influenced car accidents over time in Seattle. It aims to elucidate whether insufficient lighting contributes to accident occurrences. Users have the flexibility to select the desired year for analysis, enabling a focused examination of trends and patterns."),
      br(),  # Add a line break for spacing
    )
  ),
  
  # Lets the user choose which year they want to view
  sidebarLayout(
    mainPanel(
      fluidRow(
        column(
          width = 8,
          selectInput("year","Select Year",choices = unique(total_accident$year))
        )
      )
    ),
    
    # The output
    mainPanel(
      fluidRow(
        column(
          width = 12,
          plotlyOutput("plot", width = "150%", height = "600px")
        )
      )
    )
  )
)

server <- function(input, output) {
  # Creating the data with the year selected by the user
  data <- reactive({
    filter(total_accident, year == input$year)
  })
  
  output$plot <- renderPlotly({
     lightcond_colors <- c("Daylight" = "blue", "Dark - Street Lights On" = "green", "Dusk" = "orange", "Dawn" = "red", "Dark - No Street Lights" = "purple", "Dark - Street Lights Off" = "brown", "Unknown" = "gray", "Other" = "black")
    # Creating the plot
    p <- ggplot(data(), aes(x = month, y = Number_Accidents, group = LIGHTCOND, color = LIGHTCOND)) +
      geom_line() +
      scale_x_discrete(limits = 1:12, labels = month.abb) +
      labs(x = "Year-Month", y = "Number of Accidents", title = paste("Car Crashes by Light Condition in", input$year)) +
       scale_color_manual(values = lightcond_colors) + 
      theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels by 45 degrees
    
     ggplotly(p) %>%
layout(legend = list(orientation = "h"))
    
    ggplotly(p, tooltip = "text")

  })
}

shinyApp(ui = ui, server = server)
```

Scatter
===================================== 

```{r Scatter_Plot2}
# Read the dataset from Excel file
Seattle_Car_Crashes <- read_excel("Seattle Car Crashes.xlsx")

# Filter out rows with unknown or irrelevant junction types
valid_junction_types <- c("At Intersection (but not related to intersection)",
                          "At Intersection (intersection related)",
                          "Driveway Junction",
                          "Mid-Block (but intersection related)",
                          "Mid-Block (not related to intersection)")
Seattle_Car_Crashes <- Seattle_Car_Crashes %>%
  filter(JUNCTIONTYPE %in% valid_junction_types)

# UI
ui <- fluidPage(
  titlePanel("Seattle Car Crashes: # of Injuries and Severity Level at which Junction"),
  fluidRow(
    column(
      width = 12,
      plotlyOutput("crash_plot", width = "97%", height = "600px")
    )
  )
)

# server logic
server <- function(input, output) {
  # Output the interactive plot
  output$crash_plot <- renderPlotly({
    p <- ggplot(Seattle_Car_Crashes, aes(x = SEVERITYCODE, y = INJURIES, color = JUNCTIONTYPE, shape = JUNCTIONTYPE)) +
      geom_point(size = 6) + # Increase size for better visibility
      scale_shape_manual(values = c(16, 17, 15, 4, 2)) + # this is to have different shapes
      labs(x = "Severity Level", y = "# of Injuries", color = "Junction Type", shape = "Junction Type") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), panel.background = element_rect(fill = "lightgrey"))
    
    ggplotly(p)
  })
}

# run the application
shinyApp(ui = ui, server = server)
```

Bubble chart
===================================== 
```{r}
library(plotly)
library(dplyr)

# Filter out rows with unknown or irrelevant junction types
valid_junction_types <- c("At Intersection (but not related to intersection)",
                          "At Intersection (intersection related)",
                          "Driveway Junction",
                          "Mid-Block (but intersection related)",
                          "Mid-Block (not related to intersection)")
Seattle_Car_Crashes <- Seattle_Car_Crashes %>%
  filter(JUNCTIONTYPE %in% valid_junction_types)

# UI for the bubble chart
ui <- fluidPage(
  titlePanel("Seattle Car Crashes: Relationship Between Collision Type and Junction Type"),
  
  fluidRow(
    column(
      width = 12,
      h3("Graph Description"),
      p("This interactive bubble chart illustrates the relationship between junction types and collision types for car crashes in Seattle. Users can select a specific year to analyze the distribution of collision types across different junction types."),
      br()  # Add a line break for spacing
    )
  ),
  
  fluidRow(
    column(
      width = 8,
      selectInput("year","Select Year",choices = unique(year(Seattle_Car_Crashes$INCDATE)))
    )
  ),
  
  fluidRow(
    column(
      width = 12,
      plotlyOutput("bubble_chart", width = "100%", height = "600px")
    )
  )
)

# Server logic for the bubble chart
server <- function(input, output) {
  # Reactive expression for filtered data based on selected year
  filtered_data <- reactive({
    Seattle_Car_Crashes %>%
      filter(year(INCDATE) == input$year) %>%
      group_by(COLLISIONTYPE, JUNCTIONTYPE) %>%
      summarise(count = n()) %>%
      ungroup()
  })
  
  # Output the interactive bubble chart
  output$bubble_chart <- renderPlotly({
    plot_ly(filtered_data(), x = ~COLLISIONTYPE, y = ~JUNCTIONTYPE, size = ~count, color = ~count, type = "scatter", mode = "markers", marker = list(sizemode = "diameter")) %>%
      layout(
        title = paste("Relationship Between Junction Type and Collision Type in", input$year),
        xaxis = list(title = "Collision Type"),
        yaxis = list(title = "Junction Type"),
        hoverinfo = "text",
        hovertext = ~paste("Collision Type: ", COLLISIONTYPE, "<br>Junction Type: ", JUNCTIONTYPE, "<br>Count: ", count),
        showlegend = FALSE
      )
  })
}

# Run the shiny app
shinyApp(ui = ui, server = server)

```