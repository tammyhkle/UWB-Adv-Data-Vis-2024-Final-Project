---
title: "Seattle Car Crashes"
author: "Simoli Aghara, Mindy Chen, Rachel Graham, Tammy Le"
date: "`r Sys.Date()`"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
```


About
===================================== 

### About Section

This is about Seattle Car Crashes. 

Table
===================================== 

```{r}
library(readxl)
library(tidyverse)
library(DT)
library(dplyr)
library(ggmap)
library(ggplot2)
library(plotly)
library(shiny)
Seattle_Car_Crashes <- read_excel("Seattle Car Crashes.xlsx")
Seattle_Car_Crashes <- na.omit(Seattle_Car_Crashes)
Seattle_Car_Crashes <- subset(Seattle_Car_Crashes, select = -c(INCDTTM))
datatable(Seattle_Car_Crashes)

```

Geolocation
===================================== 
```{r}

# google API??? or library(opencage) <- Free API?

library(plotly)
library(readxl)
library(ggmap)

# read the dataset from Excel file
Seattle_Car_Crashes <- read_excel("Seattle Car Crashes.xlsx")

# extract addresses from the "LOCATION" column
addresses <- Seattle_Car_Crashes$LOCATION

# initialize empty vectors to store latitude and longitude
lat <- numeric(length(addresses))
lon <- numeric(length(addresses))

# geocode each address using ggmap -> this is because we dont have longitude and latitude..
for (i in seq_along(addresses)) {
  # Geocode the address
  result <- geocode(addresses[i])
  
  # Extract latitude and longitude
  if (!is.na(result$lon) && !is.na(result$lat)) {
    lat[i] <- result$lat
    lon[i] <- result$lon
  } else {
    cat("Geocoding failed for address:", addresses[i], "\n")
  }
}

# combine geocoded data with original collision data
collision_data <- cbind(Seattle_Car_Crashes, lat, lon)

# create bubble map
fig <- plot_ly(data = collision_data, type = 'scattergeo', mode = 'markers',
               lon = ~lon, lat = ~lat,
               marker = list(size = 10, color = 'blue'),
               text = ~paste("Location: ", LOCATION))

# customize layout
fig <- fig %>% layout(title = 'Seattle Car Crashes',
                      geo = list(scope = 'usa', projection = list(type = 'albers usa'),
                                 showland = TRUE, landcolor = toRGB("gray85"),
                                 subunitwidth = 1, countrywidth = 1,
                                 subunitcolor = toRGB("white"), countrycolor = toRGB("white")))

# display the bubble map
fig

```

Scatter + Line
===================================== 

Scatter plot: Correlation between weather conditions, daylight vs nighttime, and road conditions. - Rachel 
Line Graph: Correlation between date, and time(daylight vs nighttime) - Simoli

```{r}
ui <- fluidPage(
  titlePanel("Seattle Car Crashes Weather, Road, and Light Conditions"),
  fluidRow(
    column(
      width = 12,
      plotlyOutput("crash_plot", width = "100%", height = "600px")
    )
  )
)

server <- function(input, output) {
  # Data processing
  Seattle_Car_Crashes <- Seattle_Car_Crashes %>%
    mutate(Weather_Combined = case_when(
      WEATHER %in% c("Clear", "Overcast", "Partly Cloudy") ~ "Clear",
      WEATHER %in% c("Fog/Smog/Smoke") ~ "Fog",
      WEATHER %in% c("Raining", "Sleet/Hail/Freezing Rain") ~ "Rain",
      WEATHER %in% c("Snowing", "Blowing Snow") ~ "Snow",
      WEATHER %in% c("Other", "Blowing Sand/Dirt", "Severe Crosswind") ~ "Other",
      TRUE ~ WEATHER  # Keep other values unchanged
    )) %>%
    mutate(Light_Combined = case_when(
      LIGHTCOND == "Daylight" ~ "Daylight",
      LIGHTCOND %in% c("Dawn", "Dusk") ~ "Dawn/Dusk",
      LIGHTCOND %in% c("Dark - Street Lights On", "Dark - Unknown Lighting", "Dark - Street Lights Off", "Dark - No Street Lights") ~ "Dark",
      TRUE ~ LIGHTCOND  # Keep other values unchanged
    )) %>%
    mutate(Road_Combined = case_when(
      ROADCOND == "Dry" ~ "Dry",
      ROADCOND %in% c("Wet", "Standing Water", "Snow/Slush", "Sand/Mud/Dirt", "Oil") ~ "Wet",
      ROADCOND == c("Ice") ~ "Ice",
      TRUE ~ ROADCOND  # Keep other values unchanged
    )) %>%
    filter(WEATHER != "Unknown" & LIGHTCOND != "Unknown" & LIGHTCOND != "Other" & ROADCOND != "Unknown" & ROADCOND != "Other")

  # Calculate the count of car crashes for each combination
  crash_counts <- Seattle_Car_Crashes %>%
    group_by(Weather_Combined, Light_Combined, Road_Combined) %>%
    summarise(Count = n())

  # Output the interactive plot
  output$crash_plot <- renderPlotly({
    p <- ggplot(crash_counts, aes(x = Weather_Combined, y = Count, color = Light_Combined, shape = Road_Combined, text = paste("Weather:", Weather_Combined, "<br>Light:", Light_Combined, "<br>Road:", Road_Combined, "<br>Crashes:", Count))) +
      geom_point(size = 3) +
      labs(x = "Weather Condition", y = "Number of Car Crashes", color = "Light Condition", shape = "Road Condition") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    
    ggplotly(p, tooltip = "text")
  })
}

shinyApp(ui = ui, server = server)
```

```{r}
# Separating the date column from the dataset
Seattle_Car_Crashes_Date <- Seattle_Car_Crashes %>%
  mutate(year = year(INCDATE), month = month(INCDATE))

# Counting the total number of accidents happened in a particular month
total_accident <- Seattle_Car_Crashes_Date %>%
  group_by(LIGHTCOND, year, month) %>%
  summarise(Number_Accidents = n())

# Making the graph interactive
ui <- fluidPage(

  # Giving the title to the graph
  titlePanel("Car Crashes by Light Condition over Time"),
  
  # Lets the user choose which year they want to view
  sidebarLayout(
    sidebarPanel(
      selectInput("year", "Select Year", choices = unique(total_accident$year))
    ),
    
    # The output
    mainPanel(
      plotOutput("plot")
    )
  )
)

server <- function(input, output) {
  # Creating the data with the year selected by the user
  data <- reactive({
    filter(total_accident, year == input$year)
  })
  

  output$plot <- renderPlot({
    # Creating the plot
    ggplot(data(), aes(x = paste(year, month, sep = "-"), y = Number_Accidents, group = LIGHTCOND, color = LIGHTCOND)) +
      geom_line() +
      labs(x = "Year-Month", y = "Number of Accidents", title = paste("Car Crashes by Light Condition in", input$year))
  })
}

shinyApp(ui = ui, server = server)
```

Scatter + Bar
===================================== 

Bar Graph: Type of Accident and Junction and Severity - Mindy
Scatter plot: Compare # of Injuries to Severity and Type of Junction (intersections) - Tammy 

Tammy Le (Scatter Plot):
```{r}
# Read the dataset from Excel file
Seattle_Car_Crashes <- read_excel("Seattle Car Crashes.xlsx")

# Filter out rows with unknown or irrelevant junction types
valid_junction_types <- c("At Intersection (but not related to intersection)",
                          "At Intersection (intersection related)",
                          "Driveway Junction",
                          "Mid-Block (but intersection related)",
                          "Mid-Block (not related to intersection)")
Seattle_Car_Crashes <- Seattle_Car_Crashes %>%
  filter(JUNCTIONTYPE %in% valid_junction_types)

# UI
ui <- fluidPage(
  titlePanel("Seattle Car Crashes: # of Injuries and Severity Level at which Junction"),
  fluidRow(
    column(
      width = 12,
      plotlyOutput("crash_plot", width = "97%", height = "600px")
    )
  )
)

# server logic
server <- function(input, output) {
  # Output the interactive plot
  output$crash_plot <- renderPlotly({
    p <- ggplot(Seattle_Car_Crashes, aes(x = SEVERITYCODE, y = INJURIES, color = JUNCTIONTYPE, shape = JUNCTIONTYPE)) +
      geom_point(size = 6) + # Increase size for better visibility
      scale_shape_manual(values = c(16, 17, 15, 4, 2)) + # this is to have different shapes
      labs(x = "Severity Level", y = "# of Injuries", color = "Junction Type", shape = "Junction Type") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    
    ggplotly(p)
  })
}

# run the application
shinyApp(ui = ui, server = server)
```